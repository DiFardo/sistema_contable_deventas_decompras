{% extends "pagina_maestra.html" %}

{% block titulo %}Libro Mayor{% endblock %}

{% block link %}
<!-- Material Icons for icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/tabla_cuentas.css') }}" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

{% endblock %}

{% block contenido %}

<div id="content">
    <div class="main-content">
        <!-- Breadcrumb dinámico -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                {% for crumb in breadcrumbs %}
                {% if loop.last %}
                <li class="breadcrumb-item active" aria-current="page">{{ crumb.name }}</li>
                {% else %}
                <li class="breadcrumb-item"><a href="{{ crumb.url }}">{{ crumb.name }}</a></li>
                {% endif %}
                {% endfor %}
            </ol>
        </nav>

        <!-- Encabezado con título adicional -->
        <div class="row mb-3">
            <div class="col-12">
                <h2 class="text-left">Libro Mayor - Detalle de las operaciones</h2>
            </div>
        </div>

        <!-- Filtros: Fecha exacta y RUC en una sola fila alineados correctamente con centrado vertical -->
        <div class="row mb-3 align-items-center">
            <div class="col-lg-3 col-md-6 col-sm-12 d-flex">
                <label class="me-3 d-flex justify-content-center align-items-center" style="min-width: 100px;">
                    <strong>PERÍODO:</strong>
                </label>
                <input type="month" class="form-control" id="filtro-fecha" max="{{ current_year }}-12"
                    value="{{ current_year }}-01">
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12 d-flex">
                <label class="me-3 d-flex justify-content-center align-items-center" style="min-width: 100px;">
                    <strong>RUC:</strong>
                </label>
                <input type="text" class="form-control" value="20612188930" readonly>
            </div>
            <div class="col-lg-6 col-md-12 col-sm-12 d-flex">
                <label class="me-3 d-flex justify-content-center align-items-center" style="min-width: 100px;">
                    <strong>DENOMINACION O RAZON SOCIAL:</strong>
                </label>
                <input type="text" class="form-control" value="DECO ELERA S.A.C." readonly>
            </div>
        </div>

        <div class="table-wrapper">
            <div class="table-title">
                <div class="row justify-content-between align-items-center">
                    <!-- Input Group para Filtro de Búsqueda a la izquierda -->
                    <div class="col-lg-4 col-md-6 col-sm-12 d-flex justify-content-start">
                        <div class="input-group">
                            <input type="text" id="search-input" class="form-control"
                                placeholder="Buscar en la tabla..." aria-label="Buscar">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="material-icons">search</i>
                            </button>
                        </div>
                    </div>

                    <!-- Botones Alineados a la Derecha para Imprimir y Exportar -->
                    <div class="col-lg-4 col-md-6 col-sm-12 d-flex justify-content-end">
                        <button class="btn btn-primary me-2" style="background-color: orange;"
                            onclick="generarReporte()">
                            <i class="material-icons">print</i>
                        </button>
                        <button class="btn btn-primary me-2" style="background-color: blue;"
                            onclick="exportTableToCSV('libro_mayor.csv')">
                            <i class="fas fa-file-csv"></i>
                        </button>
                        <button class="btn btn-primary me-2" style="background-color: green;"
                            onclick="exportTableToExcel()">
                            <i class="fas fa-file-excel"></i>
                        </button>
                        <button class="btn btn-primary me-2" style="background-color: red;"
                            onclick="exportTableToPDF()">
                            <i class="material-icons">picture_as_pdf</i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Estructura de la tabla del Libro Mayor -->
            <table class="table table-bordered table-striped table-hover">
                <thead>
                    <tr>
                        <th rowspan="2">CUENTAS</th>
                        <th rowspan="2">FECHA DE LA OPERACIÓN</th>
                        <th rowspan="2">NÚMERO CORRELATIVO DEL LIBRO DIARIO</th>
                        <th rowspan="2">DESCRIPCIÓN DE LA OPERACIÓN</th>
                        <th colspan="2">SALDOS Y MOVIMIENTOS</th>
                    </tr>
                    <tr>
                        <th>DEUDOR</th>
                        <th>ACREEDOR</th>
                    </tr>
                </thead>
                <tbody id="tabla-cuerpo">
                    <!-- Datos de prueba del Libro Mayor -->
                    <tr>
                        <td>1001 - Caja</td>
                        <td>2024-10-01</td>
                        <td>00001</td>
                        <td>Ingreso de efectivo</td>
                        <td style="text-align: right">5000.00</td>
                        <td style="text-align: right">0.00</td>
                    </tr>
                    <tr>
                        <td>1001 - Caja</td>
                        <td>2024-10-05</td>
                        <td>00002</td>
                        <td>Ingreso de efectivo</td>
                        <td style="text-align: right">0.00</td>
                        <td style="text-align: right">1500.00</td>
                    </tr>
                    <tr>
                        <td>1001 - Caja</td>
                        <td>2024-10-10</td>
                        <td>00003</td>
                        <td>Ingreso de efectivo</td>
                        <td style="text-align: right">2000.00</td>
                        <td style="text-align: right">0.00</td>
                    </tr>
                    <tr>
                        <td>1001 - Caja</td>
                        <td>2024-10-15</td>
                        <td>00004</td>
                        <td>Ingreso de efectivo</td>
                        <td style="text-align: right">0.00</td>
                        <td style="text-align: right">300.00</td>
                    </tr>
                    <tr>
                        <td>1001 - Caja</td>
                        <td>2024-10-20</td>
                        <td>00005</td>
                        <td>Ingreso de efectivo</td>
                        <td style="text-align: right">1000.00</td>
                        <td style="text-align: right">0.00</td>
                    </tr>
                    <tr>
                        <td>1001 - Caja</td>
                        <td>2024-10-25</td>
                        <td>00006</td>
                        <td>Ingreso de efectivo</td>
                        <td style="text-align: right">0.00</td>
                        <td style="text-align: right">700.00</td>
                    </tr>
                    <tr>
                        <td>1001 - Caja</td>
                        <td>2024-01-05</td>
                        <td>00007</td>
                        <td>Ingreso de efectivo</td>
                        <td style="text-align: right">3000.00</td>
                        <td style="text-align: right">0.00</td>
                    </tr>
                    <tr>
                        <td>1001 - Caja</td>
                        <td>2024-01-10</td>
                        <td>00008</td>
                        <td>Pago de proveedor</td>
                        <td style="text-align: right">0.00</td>
                        <td style="text-align: right">1500.00</td>
                    </tr>
                    <tr>
                        <td>1001 - Caja</td>
                        <td>2024-02-03</td>
                        <td>00009</td>
                        <td>Venta de productos</td>
                        <td style="text-align: right">4000.00</td>
                        <td style="text-align: right">0.00</td>
                    </tr>
                    <tr>
                        <td>1001 - Caja</td>
                        <td>2024-02-18</td>
                        <td>00010</td>
                        <td>Pago de impuestos</td>
                        <td style="text-align: right">0.00</td>
                        <td style="text-align: right">2000.00</td>
                    </tr>
                    <tr>
                        <td>1001 - Caja</td>
                        <td>2024-03-08</td>
                        <td>00011</td>
                        <td>Ingreso por servicios</td>
                        <td style="text-align: right">5000.00</td>
                        <td style="text-align: right">0.00</td>
                    </tr>
                    <tr>
                        <td>1001 - Caja</td>
                        <td>2024-03-22</td>
                        <td>00012</td>
                        <td>Pago de sueldos</td>
                        <td style="text-align: right">0.00</td>
                        <td style="text-align: right">3500.00</td>
                    </tr>
                    <tr>
                        <td>1001 - Caja</td>
                        <td>2024-04-02</td>
                        <td>00013</td>
                        <td>Venta de productos</td>
                        <td style="text-align: right">6000.00</td>
                        <td style="text-align: right">0.00</td>
                    </tr>
                    <tr>
                        <td>1001 - Caja</td>
                        <td>2024-04-15</td>
                        <td>00014</td>
                        <td>Pago de alquiler</td>
                        <td style="text-align: right">0.00</td>
                        <td style="text-align: right">2500.00</td>
                    </tr>
                    <tr>
                        <td>1001 - Caja</td>
                        <td>2024-05-10</td>
                        <td>00015</td>
                        <td>Ingreso de efectivo</td>
                        <td style="text-align: right">4500.00</td>
                        <td style="text-align: right">0.00</td>
                    </tr>
                    <tr>
                        <td>1001 - Caja</td>
                        <td>2024-05-25</td>
                        <td>00016</td>
                        <td>Pago de proveedores</td>
                        <td style="text-align: right">0.00</td>
                        <td style="text-align: right">4000.00</td>
                    </tr>
                    <tr>
                        <td>1001 - Caja</td>
                        <td>2024-06-05</td>
                        <td>00017</td>
                        <td>Ingreso por venta</td>
                        <td style="text-align: right">3500.00</td>
                        <td style="text-align: right">0.00</td>
                    </tr>
                    <tr>
                        <td>1001 - Caja</td>
                        <td>2024-06-20</td>
                        <td>00018</td>
                        <td>Pago de impuestos</td>
                        <td style="text-align: right">0.00</td>
                        <td style="text-align: right">1500.00</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4">TOTALES</td>
                        <td style="text-align: right">8000.00</td>
                        <td style="text-align: right">2500.00</td>
                    </tr>
                </tfoot>

                <!-- <tbody id="tabla-cuerpo">
                    ### Aquí van las filas dinámicas de datos
                    {% for movimiento in movimientos %}
                    <tr>
                        <td>{{ movimiento.fecha_operacion }}</td>
                        <td>{{ movimiento.numero_correlativo_libro }}</td>
                        <td>{{ movimiento.descripcion_glosa }}</td>
                        <td style="text-align: right">{{ movimiento.debe }}</td>
                        <td style="text-align: right">{{ movimiento.haber }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4">TOTALES</td>
                        <td>{{ total_debe }}</td>
                        <td>{{ total_haber }}</td>
                    </tr>
                </tfoot> -->
            </table>

        </div>
    </div>

    <!-- Scripts al final de la página para mejorar la carga -->
    <script src="{{ url_for('static', filename='js/jquery-3.3.1.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/popper.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabla_cuentas.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        function exportTableToExcel(filename = 'libro_mayor.xlsx') {
            var table = document.querySelector('table');
            var wb = XLSX.utils.table_to_book(table, { sheet: "Libro Mayor" });
            XLSX.writeFile(wb, filename);
        }
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
          const searchInput = document.getElementById('search-input');
          const searchButton = document.querySelector('.btn-outline-secondary');
          const totalRow = document.querySelector('tfoot tr');

          // Función para convertir texto a número
          function textToNumber(text) {
              return parseFloat(text.replace(/,/g, '').replace(/\s/g, '')) || 0;
          }

          // Función para filtrar filas y actualizar totales
          function filterAndUpdate() {
              const searchValue = searchInput.value.trim();
              const rows = document.querySelectorAll('#tabla-cuerpo tr');
              let totalDeudor = 0, totalAcreedor = 0;
              
              rows.forEach(row => {
                  const correlativo = row.querySelector('td:nth-child(3)').textContent.trim();
                  const isMatch = correlativo.includes(searchValue);

                  // Mostrar u ocultar fila según el filtro
                  if (isMatch) {
                      row.style.display = '';
                      // Sumar deudor y acreedor de filas visibles
                      totalDeudor += textToNumber(row.querySelector('td:nth-child(5)').textContent);
                      totalAcreedor += textToNumber(row.querySelector('td:nth-child(6)').textContent);
                  } else {
                      row.style.display = 'none';
                  }
              });

              // Actualizar la fila de totales con los valores calculados
              totalRow.querySelector('td:nth-child(5)').textContent = totalDeudor.toFixed(2);
              totalRow.querySelector('td:nth-child(6)').textContent = totalAcreedor.toFixed(2);
          }

          // Agregar eventos
          searchButton.addEventListener('click', filterAndUpdate);
          searchInput.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') {
                  e.preventDefault();
                  filterAndUpdate();
              }
          });
          searchInput.addEventListener('input', () => {
              if (searchInput.value.trim() === '') {
                  // Mostrar todas las filas y recalcular los totales
                  document.querySelectorAll('#tabla-cuerpo tr').forEach(row => row.style.display = '');
                  filterAndUpdate(); 
              }
          });

          // Inicializa los totales al cargar la página
          filterAndUpdate();
      });
    </script>

<script>
    async function exportTableToPDF() {
        const { jsPDF } = window.jspdf;

        // Crear un contenedor temporal para la tabla y encabezado
        const tempContainer = document.createElement('div');
        tempContainer.style.width = '100%';
        tempContainer.style.padding = '10px';
        tempContainer.style.fontFamily = 'Arial, sans-serif';

        // Encabezado del reporte
        const encabezadoHTML = `
            <div style="text-align: center; margin-bottom: 20px;">
                <h2>Reporte de Libro Mayor</h2>
                <p><strong>Período:</strong> ${document.getElementById('filtro-fecha').value}</p>
                <p><strong>RUC:</strong> 20612188930</p>
                <p><strong>Denominación o Razón Social:</strong> DECO ELERA S.A.C.</p>
            </div>
        `;

        // Agregar el encabezado y la tabla al contenedor temporal
        tempContainer.innerHTML = encabezadoHTML + document.querySelector('table').outerHTML;

        // Agregar el contenedor temporal al body (oculto)
        document.body.appendChild(tempContainer);

        // Capturar el contenedor temporal como imagen usando html2canvas
        html2canvas(tempContainer, {
            scale: 2, // Escalar para una mejor resolución
            useCORS: true, // Permitir CORS para imágenes externas
            logging: false // Desactivar logs
        }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4'); // 'p' para orientación vertical

            // Calcular las dimensiones de la imagen para adaptarse a la página A4
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = pageWidth - 20; // Dejar margen de 10mm en ambos lados
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            // Ajustar la imagen en la página A4
            pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);

            // Guardar el archivo PDF con el nombre deseado
            pdf.save('libro_mayor.pdf');

            // Eliminar el contenedor temporal del body
            document.body.removeChild(tempContainer);
        }).catch(error => {
            console.error('Error al generar el PDF:', error);
            alert('Ocurrió un error al exportar a PDF. Por favor, inténtalo de nuevo.');
        });
    }
</script>


    <script>
        function exportTableToCSV(filename) {
            // Añade BOM al inicio para soporte de UTF-8
            const bom = "\uFEFF";

            let csv = Array.from(document.querySelectorAll("table tr"))
                .map(row => Array.from(row.querySelectorAll("td, th"))
                    .map(cell => cell.innerText).join(","))
                .join("\n");

            // Combina el BOM con el contenido CSV
            let csvFile = new Blob([bom + csv], { type: "text/csv;charset=utf-8;" });
            let downloadLink = document.createElement("a");
            downloadLink.href = URL.createObjectURL(csvFile);
            downloadLink.download = filename;
            downloadLink.click();
        }
    </script>

    <script>
        // Función para obtener el mes y año actuales en formato YYYY-MM
        function getCurrentMonthYear() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Mes empieza en 0, así que sumamos 1
            return `${year}-${month}`;
        }

        // Establece el mes y año actuales como valor predeterminado en el filtro de fecha
        document.addEventListener('DOMContentLoaded', function () {
            const filtroFecha = document.getElementById('filtro-fecha');
            const currentMonthYear = getCurrentMonthYear();
            filtroFecha.value = currentMonthYear; // Establecer valor como mes y año actuales
            filtroFecha.max = currentMonthYear; // Fecha máxima como mes y año actuales
        });
    </script>

    <!-- Iframe oculto para la impresión -->
    <iframe id="reporteIframe" style="display: none;"></iframe>
    <script>
        function generarReporte() {
            // Obtener los datos de período, RUC y razón social
            const periodo = document.getElementById('filtro-fecha').value;
            const ruc = document.querySelector('input[value="20612188930"]').value;
            const razonSocial = document.querySelector('input[value="DECO ELERA S.A.C."]').value;

            // Obtener el contenido de la tabla del Libro Mayor
            const tablaHTML = document.querySelector('table').outerHTML;

            // Obtener la fecha y hora actual de impresión
            const fechaHoraImpresion = new Date();
            const fechaImpresion = fechaHoraImpresion.toLocaleDateString();
            const horaImpresion = fechaHoraImpresion.toLocaleTimeString();

            // Contenido del reporte en HTML
            const contenidoReporte = `
            <html>
            <head>
                <title>Reporte - Libro Mayor</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    h1 { text-align: center; color: #343A49; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
                    th { background-color: #f2f2f2; }
                </style>
            </head>
            <body>
                <p><strong>Fecha y Hora de impresión:</strong> ${fechaImpresion} ${horaImpresion}</p>
                <h1 style=>Reporte de Libro Mayor</h1>
                <div class="datos-reporte">
                    <p><strong>Período:</strong> ${periodo}</p>
                    <p><strong>RUC:</strong> ${ruc}</p>
                    <p><strong>Denominación o Razón Social:</strong> ${razonSocial}</p>
                </div>
                ${tablaHTML}
            </body>
            </html>`;

            // Obtener el iframe oculto
            const iframe = document.getElementById('reporteIframe');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

            // Escribir el contenido del reporte en el iframe
            iframeDoc.open();
            iframeDoc.write(contenidoReporte);
            iframeDoc.close();

            // Imprimir el contenido del iframe
            iframe.contentWindow.focus();
            iframe.contentWindow.print();
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const filtroFecha = document.getElementById('filtro-fecha');
            const filasTabla = document.querySelectorAll('tbody tr'); // Filas del cuerpo de la tabla

            // Función para filtrar las filas según el mes seleccionado
            function filtrarPorMes() {
                const selectedMonth = filtroFecha.value; // Formato: YYYY-MM

                // Si no hay mes seleccionado, muestra todas las filas
                if (!selectedMonth) {
                    filasTabla.forEach(fila => fila.style.display = '');
                    return;
                }

                // Filtrar por el mes seleccionado
                filasTabla.forEach(fila => {
                    const fechaOperacion = fila.cells[1].innerText.slice(0, 7); // Obtener YYYY-MM de la fecha
                    fila.style.display = (fechaOperacion === selectedMonth) ? '' : 'none'; // Mostrar u ocultar
                });
            }

            // Mostrar todas las filas al cargar la página
            filasTabla.forEach(fila => fila.style.display = '');

            // Llama a la función al cambiar el valor del input
            filtroFecha.addEventListener('change', filtrarPorMes);
        });
    </script>
</div>
{% endblock %}